name: Deploy to Production

# Only runs when manually triggered
on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    environment:
      name: ${{ github.event.inputs.environment }}
      url: http://64.227.129.88

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to DigitalOcean
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          script: |
            echo "üöÄ Starting deployment..."
            
            # Navigate to project directory
            cd /var/www/html
            
            # Enable maintenance mode
            php artisan down --render="errors::503" --retry=60
            
            # Pull latest code from main branch
            echo "üì• Pulling latest code..."
            git pull origin main
            
            # Install/Update Composer dependencies (production)
            echo "üì¶ Installing Composer dependencies..."
            # Remove Telescope service provider registration for production
            sed -i 's/App\\Providers\\TelescopeServiceProvider::class,/\/\/ App\\Providers\\TelescopeServiceProvider::class,/' config/app.php
            composer install --no-dev --optimize-autoloader --no-interaction
            
            # Install/Update NPM dependencies and build assets
            echo "üé® Building frontend assets..."
            npm ci --production
            npm run build
            
            # Run database migrations
            echo "üíæ Running migrations..."
            php artisan migrate --force
            
            # Clear all caches
            echo "üßπ Clearing caches..."
            php artisan cache:clear
            php artisan config:clear
            php artisan route:clear
            php artisan view:clear
            
            # Optimize for production
            echo "‚ö° Optimizing..."
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache
            php artisan event:cache
            
            # Restart queue workers
            echo "üîÑ Restarting queue workers..."
            php artisan queue:restart
            
            # Set correct permissions
            echo "üîê Setting permissions..."
            chmod -R 755 /var/www/html
            chmod -R 775 /var/www/html/storage
            chmod -R 775 /var/www/html/bootstrap/cache
            chown -R www-data:www-data /var/www/html/storage
            chown -R www-data:www-data /var/www/html/bootstrap/cache
            
            # Disable maintenance mode
            php artisan up
            
            echo "‚úÖ Deployment completed successfully!"
